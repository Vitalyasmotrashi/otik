# Л3.№2 — Формат архива OTIK v2 с иерархией папок

Цель: описать формат файла-архива для дальнейших работ (Л3.№3 и далее),
с обязательными полями заголовка и возможностью хранить иерархию каталогов
(+7 баллов). Формат поддерживает произвольное число файлов и папок.

Все целые — little-endian. Выравнивание структур и смещений — по 8 байт.

## 1. Сигнатура и версия

- Сигнатура: 8 байт ASCII `OTIK01V2`.
  - Первые 6 байт совпадают с Л3.№1: `OTIK01` (требование «начало сигнатуры сохраняется»).
- Версия формата: мажор/минор, `major >= 1`.
  - В этом документе: `major = 1`, `minor = 0`.

## 2. Коды алгоритмов

Коды задаются на уровне заголовка (по умолчанию для всех записей) и могут
переопределяться для конкретной записи (файла). Ноль — отсутствие алгоритма.

- Код сжатия «с учётом контекста» (Ctx):
  - 0 — нет;
  - 1 — Arithmetic (зарезервировано);
  - 2 — Range (зарезервировано).
- Код сжатия «без учёта контекста» (NoCtx), применяется поверх Ctx:
  - 0 — нет;
  - 1 — RLE;
  - 2 — LZSS (зарезервировано).
- Код защиты от помех (Protection):
  - 0 — нет;
  - 1 — CRC32;
  - 2 — SHA256.

Примечание: в Л3.№3 допускается реализация «нулевого» профиля (0/0 и 0) —
без сжатия и защиты. Поля и места для служебных данных уже предусмотрены.

## 3. Общий заголовок файла-архива

Фиксированная часть (56 байт):

Offset  Size  Field                            Описание
0       8     signature                        `OTIK01V2`
8       2     version_major (uint16)           >= 1 (здесь 1)
10      2     version_minor (uint16)           (здесь 0)
12      1     comp_ctx (uint8)                 код сжатия с контекстом (по умолчанию)
13      1     comp_nctx (uint8)                код сжатия без контекста (по умолчанию)
14      1     protection (uint8)               код защиты (по умолчанию)
15      1     reserved (uint8)                 должен быть 0
16      4     toc_entries (uint32)             число записей в TOC
20      8     global_meta_offset (uint64)      смещение глоб. метаданных (может быть 0)
28      4     global_meta_length (uint32)      длина глоб. метаданных (0 если нет)
32      8     toc_offset (uint64)              смещение таблицы содержимого (TOC)
40      8     data_offset (uint64)             смещение области данных (payload pool)
48      8     total_original_size (uint64)     сумма исходных размеров всех файлов

- Все смещения заданы «от начала файла».
- Блок глобальных метаданных (если используется) предназначен для
  служебных данных алгоритмов сжатия/защиты и может иметь произвольную структуру.
- `toc_offset < data_offset`.
- Межблочные выравнивания до 8 байт заполняются нулями.

Строка `struct` для паковки этой части в Python: `"<8sHHBBBBI I Q Q Q"`.
Расшифровка: 8s, H, H, B, B, B, B, I, (I padding объединён выше), затем три Q и ещё один Q.
Реализация должна использовать точные поля и размеры из таблицы.

## 4. Таблица содержимого (TOC)

TOC — массив описателей записей. Каждая запись — файл или каталог.

Структура «EntryHeader» (фиксированная часть, 56 байт):

Offset  Size  Field                            Описание
0       2     path_len (uint16)                длина UTF‑8 пути
2       2     flags (uint16)                   биты: 0x1 — каталог; 0x2 — файл
4       4     mode (uint32)                    POSIX-права (0755 и т.п.)
8       8     mtime (uint64)                   UNIX time, секунды
16      1     comp_ctx (uint8)                 0xFF = взять из заголовка
17      1     comp_nctx (uint8)                0xFF = взять из заголовка
18      1     protection (uint8)               0xFF = взять из заголовка
19      1     reserved (uint8)                 0
20      8     original_size (uint64)           0 для каталогов
28      8     stored_size (uint64)             0 для каталогов
36      8     data_offset (uint64)             0 для каталогов; смещение от начала файла
44      4     extra_len (uint32)               длина дополнительных служебных данных
48      8     entry_id (uint64)                номер записи (для ссылок/будущего)

За фиксированной частью сразу идут:
- `path` (UTF‑8, `path_len` байт, без завершающего нуля);
- `extra` (произвольный бинарный блок длиной `extra_len`),
  где можно хранить таблицы частот, заголовки алгоритмов и проч.

Правила для путей:
- Разделитель `/`.
- Корень архива — пустой префикс. Примеры: `docs/`, `docs/a.txt`.
- Каталоги описываются отдельными записями с флагом `0x1` и нулевыми размерами.
- Порядок записей в TOC не важен, но рекомендуется сначала каталоги, затем файлы.

## 5. Область данных

Блок `data_offset .. EOF` содержит полезные данные всех файлов — в
формате согласно тройке кодов (Ctx/NoCtx/Protection) для данной записи.
Если все коды равны нулю — это просто «сырые» байты исходного файла.

Каждая запись указывает `data_offset` и `stored_size`. Таким образом,
реализация может читать данные файла без сканирования соседей.

## 6. Потоки/алгоритмы (нулевой профиль)

Для Л3.№3 допустимо реализовать только «нулевой профиль»:
- `comp_ctx = 0`, `comp_nctx = 0`, `protection = 0` в заголовке и/или записи.
- `global_meta_length = 0`, `extra_len = 0`.
- Тогда `stored_size == original_size`, а данные — точная копия исходных байтов.

## 7. Мини‑пример раскладки

Пусть архив содержит:
- `docs/` (каталог),
- `docs/a.txt` (5 байт),
- `b.bin` (3 байта).

Тогда:
- `toc_entries = 3`;
- `TOC` содержит 3 `EntryHeader` + переменную часть путей;
- `data` = concat(данные `docs/a.txt`, данные `b.bin`).

## 8. Причины выбора полей

- Сигнатура начинается с `OTIK01` для совместимости требований.
- Ненулевая версия (1.0) — требование Л3.№2; добавлена пара major/minor.
- Два кода сжатия (Ctx/NoCtx) и код защиты — прямое требование.
- Смещения на `TOC`, `data`, `global_meta` —
  позволяют добавлять служебные данные без «кардинальной переработки».
- TOC с путями UTF‑8 и флагом «каталог» —
  позволяет собирать/восстанавливать иерархию папок (+7 баллов).

## 9. Совместимость

- Декодеры будущих версий должны проверять `signature` и `version_*`.
- Если `version_major` несовместима — корректно отказывать с сообщением.
- Дополнительные поля можно расширять за счёт `extra`/`global_meta`,
  не меняя фиксированную часть заголовков.

---
Это спецификация для каталога `n2` (Л3.№2). На основе её будет реализован
кодер/декодер в Л3.№3 с профилем 0/0 и 0, а затем можно включить реальные
алгоритмы, не меняя формат.