\labwork{%Двоичное представление информации. %Исследование форматов файлов. 
Проектирование формата файлов}

% \label{lab_intro}
% \label{lab_hexedit}
\label{lab_hexcode}

\purpose{
% 1)~%изучить двоичное и шестнадцатеричное представление информации, научиться работать с шестнадцатеричным редактором; 
% 2)~изучить структуру простейших форматов файлов; 
% 3)~
научиться создавать и~обрабатывать двоичные файлы на ЯВУ.
}

% Максимальная оценка обязательной части "--- $\bsingle$ баллов. 

Максимальная оценка обязательной части "--- $\bsingle$ баллов. Максимум графы $\bsingle+\bsingle$ включает бонус за архивацию папок.

\taskabsencepenalty{-2}

\begin{tasks}

% \item С помощью hexdump/xxd или шестнадцатеричного просмотровщика/редактора исследуйте файлы различных форматов (некоторые файлы представлены в папке «\LABFILESPATH»). Выделите сигнатуры или иные признаки формата там, где это возможно.
% 
% 
% 
% \item Определите тип файла, соответствующего номеру варианта ($(\text{№}-1)\%10$), из папки «\LABFILESPATH/Варианты 1 — *». Откройте его корректным приложением.
% Поместите в отчёт тип и описание содержимого файла, а~также признаки формата, по которым удалось определить тип.
% 
% 
% \item 
% \def\img{colorchess16x16x2.bmp}
% В соответствии с~номером варианта отредактируйте изображение {\img}, используя шестнадцатеричный редактор. 
% Откройте изменённый файл и убедитесь, что изменения корректны.
% Файл {\img} "--- изображение $16\times16$ пикселей, сиренево-болотное (две сиреневые и~две болотные клетки по $8\times8$ пикселей; некоторые просмотровщики неадекватно отображают неполноцветные bmp), глубина цвета "--- 1~бит на пиксель.
% 
% \noindent
% \begin{variants}{lab_hexedit_bmpedit}
% Поставить зелёную точку в~правом нижнем углу изображения
% \next
% Поставить сиреневую точку в~правом верхнем углу изображения
% \end{variants}

\item 
\label{lab_task_intro_signature}
Выберите сигнатуру для собственного формата файлов, которая будет использоваться во всех дальнейших работах %(4-8 байт).
(6~байт).

Разработайте программу-кодек, 
состоящую из
двух частей "--- \emph{кодера} и~\emph{декодера}.

\begin{enumerate}%[label=\asbuk*),ref=\asbuk*]
\item \emph{Кодер} по заданному файлу $X$ создаёт архив $Y$ формата, описанного в~таблице~\ref{lab_task_intro_signature_fmt}.

\begin{table}[h]
\caption{Нулевая версия формата архива}\label{lab_task_intro_signature_fmt}
\renewcommand{\tabularxcolumn}[1]{m{#1}}

\noindent%
\begin{tabularx}{\linewidth}{|M{5em}|M{3.5em}|L|L|L|}\hline
Смещение поля (байты) & Размер поля (байты) &Описание поля \\\hline
0&6&Сигнатура формата (выбранное выше 6-байтовое значение) \\\hline
6&2&Версия формата (беззнаковое 16-битное целое): для задания~\ref{lab_task_intro_signature} "--- 0 \\\hline
8&8&Исходная длина $n$ файла в~байтах (беззнаковое 64-битное целое) \\\hline
16& $n$& «Сырые» данные исходного файла (несжатый текст) \\\hline
\end{tabularx}
\end{table}


\item \emph{Декодер} по заданному архиву $Y$:
\begin{itemize}
\item проверяет сигнатуру на соответствие выбранной в~\ref{lab_task_intro_signature} и~версию формата;
\item при корректных сигнатуре и~версии восстанавливает файл~$\widetilde{X}$ (который должен совпадать с~исходным~$X$) по данным архива~$Y$.
\end{itemize}
\end{enumerate}

Кодер и~декодер могут быть реализованы как в~виде двух раздельных модулей, так в~одной программе (в~последнем случае действие задаётся ключом командной строки или выбором меню "--- то есть должна быть возможность раздельного вызова кодера и декодера, а~не только слитного преобразования $X \to Y \to \widetilde{X}$).


\medskip

Проверьте при помощи шестнадцатеричного просмотровщика/редактора, что поля заголовка созданного архива соответствуют таблице~\ref{lab_task_intro_signature_fmt};
при помощи утилиты  GNU/Linux $diff$ проверьте побайтовое совпадение распакованного $\widetilde{X}$  с~исходным~$X$.
 
\descrcomment%
{%
при выполнении работы в~MS\,Windows аналог $diff$ можно найти, используя справочную команду консоли $help$.
}


\medskip


\item 
\label{lab_task_intro_format}
Разработайте и~опишите формат файла-архива для дальнейших работ (не обязан развивать таблицу~\ref{lab_task_intro_signature_fmt};
формат \ref{lab_task_intro_format} может отличаться от~\ref{lab_task_intro_signature} размером сигнатуры, но её начало должно сохраниться).
Архив обязательно содержит 
% \begin{itemize}
% \item заголовок, включающий коды использованных алгоритмов сжатия и~защиты от помех (с~учётом того, что сжатие без учёта контекста часть применяется поверх сжатия с~его учётом);
% \item опционально (содержимое зависит от использованных алгоритмов): данные, необходимые для декодирования, например, массив частот для методов сжатия без учёта контекста;
% \item закодированные данные. 
% \end{itemize}
% Заголовок должен содержать сигнатуру, а также иные данные, необходимые для различения формата и декодирования файла-архива.
%
заголовок и~закодированные данные.

% % опционально можно р "--- подзаголовки
% необходимо предусмотреть возможность добавления служебных данных

Заголовок обязательно включает:
\begin{itemize}
\item сигнатуру (в~дальнейшем все дальнейшие версии архивов команды должны использовать сигнатуру из~\ref{lab_task_intro_format});
\item версию формата (1 и~выше);
\item коды использованных алгоритмов сжатия и~защиты от помех (с~учётом того, что сжатие без учёта контекста часто применяется поверх сжатия с~его учётом);
\item исходную длину файла в~символах кодирования (то есть байтах);
\end{itemize}
а~также любые необходимые, по мнению автора, поля.

Формат должен предусматривать возможность добавления служебных данных для различных алгоритмов сжатия и~защиты от помех (например, массив частот для методов сжатия без учёта контекста) без кардинальной его  переработки.

В~качестве кодов алгоритмов, соответствующих отсутствию сжатия и~защиты от помех, используйте значение 0.

% Выбранные в данной лабораторной работе сигнатуру и формат файла необходимо использовать во всех позднейших программах кодирования/декодирования. Соответственно, заголовок должен включать как постоянную часть, необходимую для различения конкретного подтипа формата, так и элементы, зависящие от подтипа/алгоритма кодирования.
% Необходимо предусмотреть в разработанном формате возможность следующих видов кодирования:
% — энтропийное сжатие (с учётом частотности);
% — сжатие с учётом контекста;
% — защита от помех;
% причём необходимо учесть, что 
% — к одному файлу может последовательно применяться несколько видов кодирования;
% — один вид кодирования включает несколько методов (так, энтропийное сжатие включает и метод Хаффмана, и арифметическое сжатие); а один и тот же метод кодирования может быть реализован различными способами.
% Описать структуру файла в отчёте.

\item 
\label{lab_task_intro_codec_echo}
% Разработайте программу-кодек, 
% % (кодер+декодер), 
% состоящую из
% двух частей "--- \emph{кодера} и~\emph{декодера}.
% 
% \begin{enumerate}%[label=\asbuk*),ref=\asbuk*]
% \item \emph{Кодер} по заданному файлу $X$ создаёт архив $Y$ формата, разработанного в~задании~\ref{lab_task_intro_format}, состоящий из заголовка и~несжатого текста $X$ (то есть содержимого  $X$ без каких-либо преобразований, целиком).
% 
% В~качестве кодов алгоритмов, соответствующих отсутствию сжатия и~защиты от помех, используйте значение 0.
% 
% \item \emph{Декодер} по заданному архиву $Y$:
% \begin{itemize}
% \item проверяет сигнатуру на соответствие выбранной в~\ref{lab_task_intro_signature};
% \item при корректной сигнатуре проверяет коды алгоритмов;
% \item если коды соответствуют 0, восстанавливает файл~$\widetilde{X}$ (который должен совпадать с~исходным~$X$) по данным архива~$Y$.
% \end{itemize}
% \end{enumerate}
% 
% Кодер и~декодер могут быть реализованы как в~виде двух раздельных модулей, так в~одной программе (в~последнем случае действие задаётся ключом командной строки или выбором меню "--- то есть должна быть возможность раздельного вызова кодера и декодера, а~не только слитного преобразования $X \to Y \to \widetilde{X}$).

Разработайте программу-кодек (аналогично \ref{lab_task_intro_codec_echo}), 
создающую архив формата, разработанного в~задании~\ref{lab_task_intro_format}.



\end{tasks}

\subsection{О терминах}
\label{codes_termin_text}

\textbf{Символ кодирования = байт x86 = октет,} а~не печатный символ ASCII, KOI-8, Unicode etc.

\textbf{Несжатый текст $X$ = любой бинарный файл;} сжатый текст, который следует в~$Y$ после кода алгоритма и~служебной информации "--- тоже бинарный файл.

Не обманывайтесь принятой в~кодировании терминологией! (Кто обманется и~воспользуется функциями $fgetc()$ и~т.\,п. "--- минус 2 балла).


\descrcomment{%
«Маркером» текстового представления является не только $fgetc()$, но и "--- тем более "--- функции форматированного (что значит текстового) ввода-вывода и~обработки строк,
в~частности, $readLine()$, $split()$ и т.\,п.

\bottompagebreak

В~большинстве библиотек для ввода-вывода «сырых» бинарных данных есть только две функции:
\begin{itemize}
\item аналог $fread()$ для чтения из файла;
\item и~аналог $fwrite()$ для записи;
\end{itemize}
и~их \emph{достаточно.}
}


\subsection{Дополнительные бонусные и~штрафные баллы}

$-2$ балла за текстовое представление архива или если кодер обрабатывает только файлы в~текстовом представлении "--- см.~раздел~\ref{codes_termin_text}.

$-1$ балл, если структура архива, создаваемого кодеком в~задании~\ref{lab_task_intro_codec_echo}, не совпадает с~описанной в~задании~\ref{lab_task_intro_format}. 

$-1$ балл, если декодер при некорректной сигнатуре архива $Y$ всё равно создаёт  файл~$\widetilde{X}$.

% $-1$ балл, если символом кодирования является не байт, а~печатаемый символ текста (всё равно, utf8 или любой однобайтовой кодировки).
% 
% $-1$ балл, если формат заголовка архива "--- текстовый (и~ещё $-1$, если автор программы не понимает разницы между текстовым представлением данных и~расширением $.txt$).

% $+3$ балла, если в~структуре заголовка~\ref{lab_task_intro_format} и~программе~\ref{lab_task_intro_codec_echo} предусмотрена возможность собрать в~один архив несколько файлов (но не папки) и~восстановить их с~прежними именами.

$+7$ баллов, если в~структуре заголовка~\ref{lab_task_intro_format} и~программе~\ref{lab_task_intro_codec_echo} предусмотрена возможность собрать в~один архив и~восстановить ещё и~иерархическую структуру папок (не более $+4$, если можно собрать несколько файлов, но пути не сохраняются).
